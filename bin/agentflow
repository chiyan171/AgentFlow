#!/bin/zsh
# AgentFlow CLI v1.0.0
# ==================== AgentFlow CLI ====================
# 版本: v1.0.0
# 用途: AgentFlow 命令行工具
# =======================================================

# 优先使用项目本地的 CLI (Node.js 版本)
# 这允许项目使用特定版本的 AgentFlow 逻辑，并支持 docs-refresh 等复杂命令
if [[ -f ".github/scripts/agentflow.js" ]]; then
    exec node .github/scripts/agentflow.js "$@"
fi

AGENTFLOW_HOME="${AGENTFLOW_HOME:-$HOME/.agentflow}"

show_help() {
    cat << HELP
AgentFlow - AI 辅助开发工作流系统 v1.0.0

用法: agentflow <命令> [参数]

命令:
  init [目录]    初始化 AgentFlow（默认当前目录）
  version        显示版本号
  docs           打开全局文档
  help           显示帮助

注意: 在 AgentFlow 项目目录中运行将解锁更多命令:
  docs-refresh   刷新文档门户
  portal         打开项目文档门户
  validate       验证项目配置
  skills         管理技能

示例:
  agentflow init
  agentflow init /path/to/project

Agent:  @plan @implement @reviewer @tester @debug
Prompt: /auto /fix-bug /add-feature /code-review /refactor
HELP
}

init_project() {
    local target="${1:-.}"
    [[ ! -d "$target" ]] && mkdir -p "$target"
    target="$(cd "$target" && pwd)"
    echo "初始化 AgentFlow 到: $target"
    if [[ -d "$target/.github/agents" ]]; then
        echo "警告: 已存在 AgentFlow 配置"
        read -q "REPLY?是否覆盖? (y/N) " || true
        echo
        [[ ! "$REPLY" =~ ^[Yy]$ ]] && echo "取消" && return 1
    fi
    
    # 检查模板是否存在
    if [[ ! -d "$AGENTFLOW_HOME/template/.github" ]]; then
        echo "错误: 未找到模板文件。请先运行 install-global.sh 安装 AgentFlow。"
        return 1
    fi

    cp -r "$AGENTFLOW_HOME/template/.github" "$target/"
    cp -r "$AGENTFLOW_HOME/template/.vscode" "$target/" 2>/dev/null || true
    
    echo ""
    echo "✓ AgentFlow 初始化完成!"
    echo ""
    echo "下一步:"
    echo "  1. 编辑 .github/project-memory.md 填写项目信息"
    echo "  2. 用 VS Code 打开项目"
    echo "  3. 在 Copilot Chat 中测试: @plan 你好"
}

case "${1:-help}" in
    init)    init_project "$2" ;;
    version) cat "$AGENTFLOW_HOME/VERSION" 2>/dev/null || echo "1.0.0" ;;
    docs)    open "$AGENTFLOW_HOME/docs/index.html" 2>/dev/null || echo "文档: $AGENTFLOW_HOME/docs/index.html" ;;
    help|--help|-h) show_help ;;
    *)       echo "未知命令: $1"; show_help; exit 1 ;;
esac
