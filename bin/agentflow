#!/bin/zsh
# AgentFlow CLI v1.0.0
AGENTFLOW_HOME="${AGENTFLOW_HOME:-$HOME/.agentflow}"

show_help() {
    cat << HELP
AgentFlow - AI è¾…åŠ©å¼€å‘å·¥ä½œæµç³»ç»Ÿ v1.0.0
åŸºäº VS Code + GitHub Copilot | è¾¾åˆ° opencode + oh-my-opencode ç­‰ä»·åŠŸèƒ½

ç”¨æ³•: agentflow <å‘½ä»¤> [å‚æ•°]

æ ¸å¿ƒå‘½ä»¤:
  init [--force] [ç›®å½•]  åˆå§‹åŒ– AgentFlowï¼ˆé»˜è®¤å½“å‰ç›®å½•ï¼‰
                         --force/-f å¼ºåˆ¶è¦†ç›–ï¼Œä¿ç•™ project-memory.md å’Œ docs/
  sync [ç›®å½•]            åŒæ­¥æ›´æ–°ï¼ˆä¿ç•™è‡ªå®šä¹‰ï¼Œåªæ·»åŠ æ–°æ–‡ä»¶ï¼‰
  update [ç›®å½•]          æ£€æŸ¥æ›´æ–°å¹¶æ˜¾ç¤ºæ›´æ–°æŒ‡å—
  trust                  é…ç½® VS Code ä¿¡ä»»ï¼ˆæ¶ˆé™¤ Allow å¼¹çª—ï¼Œå®ç°å…¨è‡ªåŠ¨æ‰§è¡Œï¼‰

Skills æŠ€èƒ½ç®¡ç†ï¼ˆä¸‰çº§æ¶æ„ï¼‰:
  skills                 åˆ—å‡ºæ‰€æœ‰æŠ€èƒ½ï¼ˆå…¨å±€ + é¡¹ç›®çº§ + VS Codeï¼‰
  skills list            åŒä¸Š
  skills add <name>      åˆ›å»ºé¡¹ç›®çº§ AgentFlow æŠ€èƒ½ï¼ˆ.github/skills/ï¼‰
  skills add -g <name>   åˆ›å»ºå…¨å±€æŠ€èƒ½ï¼ˆ~/.config/opencode/skills/ï¼Œä¸ opencode å…±äº«ï¼‰
  skills edit <name>     ç¼–è¾‘æŠ€èƒ½
  skills remove <name>   åˆ é™¤æŠ€èƒ½
  skills show <name>     æ˜¾ç¤ºæŠ€èƒ½è¯¦æƒ…

æ–‡æ¡£ç®¡ç†:
  docs                   æ‰“å¼€ AgentFlow æ–‡æ¡£ç›®å½•
  docs-refresh [ç›®å½•]    åˆ·æ–°æ–‡æ¡£é—¨æˆ·ï¼ˆæ‰«æå¹¶æ›´æ–° manifest.jsonï¼‰
  portal [ç›®å½•]          æ‰“å¼€é¡¹ç›®æ–‡æ¡£é—¨æˆ·ï¼ˆindex.htmlï¼‰

ç³»ç»Ÿæ£€æŸ¥:
  version                æ˜¾ç¤ºç‰ˆæœ¬å·
  status                 æ£€æŸ¥ AgentFlow å®‰è£…çŠ¶æ€
  validate [ç›®å½•]        éªŒè¯é…ç½®å®Œæ•´æ€§ï¼ˆé»˜è®¤å½“å‰ç›®å½•ï¼‰
  help                   æ˜¾ç¤ºå¸®åŠ©

Agent:  @plan @implement @reviewer @tester @debug
Prompt: /auto /plan-and-execute /fix-bug /add-feature /code-review /refactor /generate-changelog

Skills è·¯å¾„ï¼ˆä¸‰çº§æ¶æ„ï¼‰:
  å…¨å±€çº§:   ~/.config/opencode/skills/<name>/SKILL.md   (ä¸ opencode å…±äº«å…±ç”¨å…±ç»´æŠ¤)
  é¡¹ç›®çº§:   .github/skills/<name>/SKILL.md              (AgentFlow ç‹¬æœ‰ï¼ŒCLI ç®¡ç†)
  VS Code:  .github/instructions/*.instructions.md      (Copilot åŸç”Ÿï¼Œè‡ªåŠ¨åŠ è½½)

é¦–æ¬¡å®‰è£…æµç¨‹:
  1. ./scripts/install-global.sh    # å…¨å±€å®‰è£…
  2. source ~/.zshrc                # åŠ è½½ç¯å¢ƒå˜é‡
  3. agentflow trust                # é…ç½®ä¿¡ä»»ï¼ˆæ¶ˆé™¤ Allow å¼¹çª—ï¼‰
  4. agentflow init ~/myproject     # åˆå§‹åŒ–é¡¹ç›®
  5. code ~/myproject               # æ‰“å¼€ VS Code

ç¤ºä¾‹:
  agentflow trust                    # ğŸ”‘ é¦–æ¬¡å®‰è£…å¿…é¡»æ‰§è¡Œï¼
  agentflow init                     # åˆå§‹åŒ–å½“å‰ç›®å½•
  agentflow init --force .           # å¼ºåˆ¶é‡ç½®å½“å‰ç›®å½•
  agentflow sync .                   # åŒæ­¥æ›´æ–°ï¼ˆä¿ç•™è‡ªå®šä¹‰ï¼‰
  agentflow docs-refresh             # åˆ·æ–°æ–‡æ¡£é—¨æˆ·
  agentflow portal                   # æ‰“å¼€æ–‡æ¡£é—¨æˆ·
  
Skills æŠ€èƒ½ç¤ºä¾‹:
  agentflow skills                   # åˆ—å‡ºæ‰€æœ‰ skillsï¼ˆä¸‰çº§ï¼‰
  agentflow skills add my-skill      # åˆ›å»ºé¡¹ç›®çº§ AgentFlow skill
  agentflow skills add -g my-skill   # åˆ›å»ºå…¨å±€ skillï¼ˆä¸ opencode å…±äº«ï¼‰
  agentflow skills edit my-skill     # ç¼–è¾‘ skill
  agentflow skills show my-skill     # æŸ¥çœ‹ skill è¯¦æƒ…
  agentflow skills remove my-skill   # åˆ é™¤ skill

æ–‡æ¡£ç›®å½•ç»“æ„:
  .github/docs/
  â”œâ”€â”€ index.html         â† æ–‡æ¡£é—¨æˆ·ï¼ˆæ€»å…¥å£ï¼‰
  â”œâ”€â”€ manifest.json      â† æ–‡æ¡£æ¸…å•ï¼ˆç‰ˆæœ¬è¿½è¸ªï¼‰
  â”œâ”€â”€ changelog/         â† å˜æ›´æ—¥å¿—
  â”œâ”€â”€ plan/              â† å¼€å‘è®¡åˆ’ï¼ˆè¿›è¡Œä¸­ï¼‰
  â”œâ”€â”€ reports/           â† å·¥ä½œæŠ¥å‘Š
  â”œâ”€â”€ references/        â† å‚è€ƒèµ„æ–™
  â””â”€â”€ archive/           â† å†å²å½’æ¡£

Skills ç›®å½•ç»“æ„ï¼ˆä¸‰çº§æ¶æ„ï¼‰:
  ~/.config/opencode/skills/         â† å…¨å±€ skillsï¼ˆä¸ opencode å…±äº«å…±ç”¨å…±ç»´æŠ¤ï¼‰
  â””â”€â”€ <skill-name>/
      â””â”€â”€ SKILL.md                   â† æŠ€èƒ½å®šä¹‰æ–‡ä»¶ï¼ˆopencode æ ¼å¼ï¼‰

  .github/skills/                    â† é¡¹ç›®çº§ AgentFlow skillsï¼ˆAgentFlow ç‹¬æœ‰ï¼‰
  â””â”€â”€ <skill-name>/
      â””â”€â”€ SKILL.md                   â† æŠ€èƒ½å®šä¹‰æ–‡ä»¶ï¼ˆé€šè¿‡ CLI ç®¡ç†ï¼‰

  .github/instructions/              â† é¡¹ç›®çº§ VS Code skillsï¼ˆåŸç”Ÿæœºåˆ¶ï¼‰
  â””â”€â”€ *.instructions.md              â† æŒ‡ä»¤æ–‡ä»¶ï¼ˆCopilot è‡ªåŠ¨åŠ è½½ï¼‰
HELP
}

# =============================================================================
# Skills æŠ€èƒ½ç®¡ç†æ¨¡å—ï¼ˆä¸‰çº§æ¶æ„ï¼šå…±äº«å…±ç”¨å…±ç»´æŠ¤ï¼‰
# =============================================================================

# å…¨å±€ skills è·¯å¾„ï¼ˆä¸ opencode/VS Code å…±äº«å…±ç”¨å…±ç»´æŠ¤ï¼‰
GLOBAL_SKILLS_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/opencode/skills"

# é¡¹ç›®çº§ AgentFlow skills è·¯å¾„
get_project_skills_dir() {
    local target="${1:-.}"
    echo "$target/.github/skills"
}

# éªŒè¯ skill åç§°åˆæ³•æ€§
validate_skill_name() {
    local name="$1"
    # è§„åˆ™ï¼š1-64å­—ç¬¦ï¼Œå°å†™å­—æ¯æ•°å­—+å•è¿å­—ç¬¦åˆ†éš”ï¼Œä¸èƒ½ä»¥è¿å­—ç¬¦å¼€å¤´ç»“å°¾
    if [[ ! "$name" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
        echo "âŒ skill åç§°æ— æ•ˆ: $name"
        echo "ğŸ“‹ å‘½åè§„åˆ™: 1-64 å­—ç¬¦ï¼Œå°å†™å­—æ¯æ•°å­—ï¼Œè¿å­—ç¬¦åˆ†éš”"
        echo "   ç¤ºä¾‹: my-skill, code-review, git-workflow"
        return 1
    fi
    if [[ ${#name} -gt 64 ]]; then
        echo "âŒ skill åç§°è¿‡é•¿ï¼ˆæœ€å¤§ 64 å­—ç¬¦ï¼‰"
        return 1
    fi
    return 0
}

# åˆ›å»º SKILL.md æ¨¡æ¿
create_skill_template() {
    local skill_dir="$1"
    local skill_name="$2"
    local timestamp=$(date +"%Y-%m-%d")
    
    mkdir -p "$skill_dir"
    cat > "$skill_dir/SKILL.md" << EOF
---
name: $skill_name
description: åœ¨æ­¤æè¿°æŠ€èƒ½çš„ç”¨é€”å’Œè§¦å‘æ¡ä»¶
license: MIT
compatibility: opencode
metadata:
  author: AgentFlow
  created: $timestamp
---

## æŠ€èƒ½æè¿°

æè¿°è¿™ä¸ªæŠ€èƒ½çš„ä¸»è¦åŠŸèƒ½å’Œä½¿ç”¨åœºæ™¯ã€‚

## è§¦å‘æ¡ä»¶

è¯´æ˜ä½•æ—¶åº”è¯¥ä½¿ç”¨è¿™ä¸ªæŠ€èƒ½ï¼š
- å½“ç”¨æˆ·è¯·æ±‚...
- å½“ä»£ç åŒ…å«...
- å½“é¡¹ç›®éœ€è¦...

## æ‰§è¡Œæ­¥éª¤

1. ç¬¬ä¸€æ­¥æ“ä½œ
2. ç¬¬äºŒæ­¥æ“ä½œ
3. ç¬¬ä¸‰æ­¥æ“ä½œ

## è¾“å‡ºæ ¼å¼

æè¿°æŠ€èƒ½æ‰§è¡Œåçš„è¾“å‡ºæ ¼å¼å’Œå†…å®¹ã€‚

## æ³¨æ„äº‹é¡¹

- ä»»ä½•éœ€è¦æ³¨æ„çš„é™åˆ¶æˆ–å‰ææ¡ä»¶
- å¯èƒ½çš„å¤±è´¥æƒ…å†µåŠå¤„ç†æ–¹å¼
EOF
    echo "$skill_dir/SKILL.md"
}

# åˆ—å‡ºæ‰€æœ‰ skills
skills_list() {
    local target="${1:-.}"
    local project_skills_dir=$(get_project_skills_dir "$target")
    
    echo "ğŸ“š Skills æŠ€èƒ½åˆ—è¡¨ï¼ˆä¸‰çº§æ¶æ„ï¼‰"
    echo "================================"
    echo ""
    
    # 1. å…¨å±€ skillsï¼ˆä¸ opencode å…±äº«ï¼‰
    echo "ğŸŒ å…¨å±€ Skillsï¼ˆ~/.config/opencode/skills/ï¼‰"
    echo "   ä¸ opencode/VS Code å…±äº«å…±ç”¨å…±ç»´æŠ¤"
    echo ""
    
    if [[ -d "$GLOBAL_SKILLS_DIR" ]]; then
        local global_count=0
        for skill_dir in "$GLOBAL_SKILLS_DIR"/*/; do
            [[ ! -d "$skill_dir" ]] && continue
            local skill_name=$(basename "$skill_dir")
            local skill_file="$skill_dir/SKILL.md"
            if [[ -f "$skill_file" ]]; then
                local description=$(grep "^description:" "$skill_file" 2>/dev/null | head -1 | sed 's/^description:[[:space:]]*//')
                [[ -z "$description" ]] && description="(æ— æè¿°)"
                echo "   âœ… $skill_name"
                echo "      â””â”€ $description"
                ((global_count++))
            fi
        done
        if [[ $global_count -eq 0 ]]; then
            echo "   (æ— å…¨å±€ skills)"
        else
            echo ""
            echo "   å…± $global_count ä¸ªå…¨å±€ skill"
        fi
    else
        echo "   (ç›®å½•ä¸å­˜åœ¨ï¼Œè¿è¡Œ 'agentflow skills add -g <name>' åˆ›å»º)"
    fi
    
    echo ""
    
    # 2. é¡¹ç›®çº§ AgentFlow skills
    echo "ğŸ“¦ é¡¹ç›®çº§ AgentFlow Skillsï¼ˆ.github/skills/ï¼‰"
    echo "   AgentFlow ç‹¬æœ‰ï¼ŒSKILL.md æ ¼å¼"
    echo ""
    
    if [[ -d "$project_skills_dir" ]]; then
        local af_count=0
        for skill_dir in "$project_skills_dir"/*/; do
            [[ ! -d "$skill_dir" ]] && continue
            local skill_name=$(basename "$skill_dir")
            local skill_file="$skill_dir/SKILL.md"
            if [[ -f "$skill_file" ]]; then
                local description=$(grep "^description:" "$skill_file" 2>/dev/null | head -1 | sed 's/^description:[[:space:]]*//')
                [[ -z "$description" ]] && description="(æ— æè¿°)"
                echo "   âœ… $skill_name"
                echo "      â””â”€ $description"
                ((af_count++))
            fi
        done
        if [[ $af_count -eq 0 ]]; then
            echo "   (æ— é¡¹ç›®çº§ AgentFlow skills)"
        else
            echo ""
            echo "   å…± $af_count ä¸ªé¡¹ç›®çº§ AgentFlow skill"
        fi
    else
        echo "   (ç›®å½•ä¸å­˜åœ¨ï¼Œè¿è¡Œ 'agentflow skills add <name>' åˆ›å»º)"
    fi
    
    echo ""
    
    # 3. é¡¹ç›®çº§ VS Code instructions
    echo "ğŸ“‹ é¡¹ç›®çº§ VS Code Skillsï¼ˆ.github/instructions/ï¼‰"
    echo "   VS Code/Copilot åŸç”Ÿæœºåˆ¶ï¼Œè‡ªåŠ¨åŠ è½½"
    echo ""
    
    local project_instructions_dir="$target/.github/instructions"
    if [[ -d "$project_instructions_dir" ]]; then
        local vsc_count=0
        for inst_file in "$project_instructions_dir"/*.instructions.md; do
            [[ ! -f "$inst_file" ]] && continue
            local inst_name=$(basename "$inst_file" .instructions.md)
            local apply_to=$(grep "^applyTo:" "$inst_file" 2>/dev/null | head -1 | sed 's/^applyTo:[[:space:]]*//' | tr -d '"')
            [[ -z "$apply_to" ]] && apply_to="**"
            echo "   âœ… $inst_name"
            echo "      â””â”€ é€‚ç”¨: $apply_to"
            ((vsc_count++))
        done
        if [[ $vsc_count -eq 0 ]]; then
            echo "   (æ—  VS Code instructions)"
        else
            echo ""
            echo "   å…± $vsc_count ä¸ª VS Code instruction"
        fi
    else
        echo "   (ç›®å½•ä¸å­˜åœ¨)"
    fi
    
    echo ""
    echo "ğŸ’¡ æç¤º:"
    echo "   åˆ›å»ºå…¨å±€ skill:     agentflow skills add -g <name>"
    echo "   åˆ›å»ºé¡¹ç›®çº§ skill:   agentflow skills add <name>"
    echo "   VS Code instruction: ç¼–è¾‘ .github/instructions/*.instructions.md"
    echo "   æŸ¥çœ‹ skill:         agentflow skills show <name>"
}

# æ·»åŠ æ–° skillï¼ˆé»˜è®¤é¡¹ç›®çº§ï¼Œ-g ä¸ºå…¨å±€ï¼‰
skills_add() {
    local global=false
    local name=""
    local target="."
    
    # è§£æå‚æ•°
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -g|--global) global=true; shift ;;
            *) 
                if [[ -z "$name" ]]; then
                    name="$1"
                else
                    target="$1"
                fi
                shift 
                ;;
        esac
    done
    
    if [[ -z "$name" ]]; then
        echo "âŒ è¯·æŒ‡å®š skill åç§°"
        echo "ç”¨æ³•: agentflow skills add [-g] <name>"
        echo ""
        echo "é€‰é¡¹:"
        echo "   -g, --global  åˆ›å»ºå…¨å±€ skillï¼ˆä¸ opencode å…±äº«ï¼‰"
        echo ""
        echo "ğŸ’¡ æç¤º:"
        echo "   é»˜è®¤åˆ›å»ºé¡¹ç›®çº§ skill: .github/skills/<name>/"
        echo "   å…¨å±€ skill:          ~/.config/opencode/skills/<name>/"
        return 1
    fi
    
    # éªŒè¯åç§°
    validate_skill_name "$name" || return 1
    
    local skill_dir
    local skill_type
    
    if [[ "$global" == true ]]; then
        skill_dir="$GLOBAL_SKILLS_DIR/$name"
        skill_type="å…¨å±€"
        echo "ğŸŒ åˆ›å»ºå…¨å±€ skill: $name"
        echo "   è·¯å¾„: $skill_dir/"
        echo "   å…±äº«: ä¸ opencode å…±äº«å…±ç”¨å…±ç»´æŠ¤"
    else
        skill_dir="$(get_project_skills_dir "$target")/$name"
        skill_type="é¡¹ç›®çº§"
        echo "ğŸ“¦ åˆ›å»ºé¡¹ç›®çº§ AgentFlow skill: $name"
        echo "   è·¯å¾„: $skill_dir/"
    fi
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if [[ -d "$skill_dir" ]]; then
        echo "âš ï¸  skill å·²å­˜åœ¨: $skill_dir"
        read -q "REPLY?æ˜¯å¦è¦†ç›–? (y/N) " || true
        echo ""
        [[ ! "$REPLY" =~ ^[Yy]$ ]] && echo "âŒ å·²å–æ¶ˆ" && return 1
    fi
    
    # åˆ›å»º skill
    local skill_file=$(create_skill_template "$skill_dir" "$name")
    
    echo ""
    echo "âœ… å·²åˆ›å»º${skill_type} skill: $name"
    echo "ğŸ“„ æ–‡ä»¶: $skill_file"
    echo ""
    echo "ä¸‹ä¸€æ­¥:"
    echo "  1. ç¼–è¾‘ SKILL.md å®šä¹‰æŠ€èƒ½è¡Œä¸º"
    echo "  2. è¿è¡Œ 'agentflow skills show $name' æŸ¥çœ‹"
    
    # å¦‚æœæœ‰ VS Codeï¼Œæä¾›æ‰“å¼€é“¾æ¥
    if command -v code &>/dev/null; then
        echo ""
        echo "ğŸ’¡ å¿«é€Ÿç¼–è¾‘: code $skill_file"
    fi
}

# ç¼–è¾‘ skill
skills_edit() {
    local name="$1"
    local target="${2:-.}"
    
    if [[ -z "$name" ]]; then
        echo "âŒ è¯·æŒ‡å®š skill åç§°"
        echo "ç”¨æ³•: agentflow skills edit <name>"
        return 1
    fi
    
    # æŸ¥æ‰¾ skillï¼ˆå…ˆé¡¹ç›®çº§ï¼Œåå…¨å±€ï¼‰
    local skill_file=""
    local skill_type=""
    local project_skills_dir=$(get_project_skills_dir "$target")
    
    if [[ -f "$project_skills_dir/$name/SKILL.md" ]]; then
        skill_file="$project_skills_dir/$name/SKILL.md"
        skill_type="é¡¹ç›®çº§"
        echo "ğŸ“¦ ç¼–è¾‘é¡¹ç›®çº§ AgentFlow skill: $name"
    elif [[ -f "$GLOBAL_SKILLS_DIR/$name/SKILL.md" ]]; then
        skill_file="$GLOBAL_SKILLS_DIR/$name/SKILL.md"
        skill_type="å…¨å±€"
        echo "ğŸŒ ç¼–è¾‘å…¨å±€ skill: $name"
    else
        echo "âŒ skill ä¸å­˜åœ¨: $name"
        echo ""
        echo "ğŸ’¡ è¿è¡Œ 'agentflow skills' æŸ¥çœ‹å¯ç”¨ skills"
        return 1
    fi
    
    # ä½¿ç”¨ç¼–è¾‘å™¨æ‰“å¼€
    if command -v code &>/dev/null; then
        echo "ğŸ“„ ä½¿ç”¨ VS Code æ‰“å¼€: $skill_file"
        code "$skill_file"
    else
        local editor="${VISUAL:-${EDITOR:-vi}}"
        echo "ğŸ“„ ä½¿ç”¨ $editor æ‰“å¼€: $skill_file"
        $editor "$skill_file"
    fi
}

# æ˜¾ç¤º skill è¯¦æƒ…
skills_show() {
    local name="$1"
    local target="${2:-.}"
    
    if [[ -z "$name" ]]; then
        echo "âŒ è¯·æŒ‡å®š skill åç§°"
        echo "ç”¨æ³•: agentflow skills show <name>"
        return 1
    fi
    
    # æŸ¥æ‰¾ skillï¼ˆå…ˆé¡¹ç›®çº§ï¼Œåå…¨å±€ï¼‰
    local skill_file=""
    local skill_type=""
    local project_skills_dir=$(get_project_skills_dir "$target")
    
    if [[ -f "$project_skills_dir/$name/SKILL.md" ]]; then
        skill_file="$project_skills_dir/$name/SKILL.md"
        skill_type="é¡¹ç›®çº§ AgentFlow"
    elif [[ -f "$GLOBAL_SKILLS_DIR/$name/SKILL.md" ]]; then
        skill_file="$GLOBAL_SKILLS_DIR/$name/SKILL.md"
        skill_type="å…¨å±€ï¼ˆä¸ opencode å…±äº«ï¼‰"
    else
        echo "âŒ skill ä¸å­˜åœ¨: $name"
        echo ""
        echo "ğŸ’¡ è¿è¡Œ 'agentflow skills' æŸ¥çœ‹å¯ç”¨ skills"
        return 1
    fi
    
    echo "ğŸ“š Skill è¯¦æƒ…: $name"
    echo "================"
    echo ""
    echo "ç±»å‹: $skill_type"
    echo "è·¯å¾„: $skill_file"
    echo ""
    echo "â”€â”€â”€ å†…å®¹ â”€â”€â”€"
    cat "$skill_file"
}

# åˆ é™¤ skill
skills_remove() {
    local name="$1"
    local target="${2:-.}"
    
    if [[ -z "$name" ]]; then
        echo "âŒ è¯·æŒ‡å®š skill åç§°"
        echo "ç”¨æ³•: agentflow skills remove <name>"
        return 1
    fi
    
    # æŸ¥æ‰¾ skillï¼ˆå…ˆé¡¹ç›®çº§ï¼Œåå…¨å±€ï¼‰
    local skill_dir=""
    local skill_type=""
    local project_skills_dir=$(get_project_skills_dir "$target")
    
    if [[ -d "$project_skills_dir/$name" ]]; then
        skill_dir="$project_skills_dir/$name"
        skill_type="é¡¹ç›®çº§ AgentFlow"
    elif [[ -d "$GLOBAL_SKILLS_DIR/$name" ]]; then
        skill_dir="$GLOBAL_SKILLS_DIR/$name"
        skill_type="å…¨å±€"
    else
        echo "âŒ skill ä¸å­˜åœ¨: $name"
        return 1
    fi
    
    echo "âš ï¸  å³å°†åˆ é™¤${skill_type} skill: $name"
    echo "ğŸ“ è·¯å¾„: $skill_dir"
    if [[ "$skill_type" == "å…¨å±€" ]]; then
        echo "ğŸŒ æ³¨æ„: æ­¤æ“ä½œå°†å½±å“ opencode å…±äº«çš„ skills"
    fi
    echo ""
    read -q "REPLY?ç¡®è®¤åˆ é™¤? (y/N) " || true
    echo ""
    
    if [[ "$REPLY" =~ ^[Yy]$ ]]; then
        rm -rf "$skill_dir"
        echo "âœ… å·²åˆ é™¤ skill: $name"
    else
        echo "âŒ å·²å–æ¶ˆ"
    fi
}

# Skills å‘½ä»¤å…¥å£
handle_skills() {
    local cmd="${1:-list}"
    shift 2>/dev/null || true
    
    case "$cmd" in
        list|ls)    skills_list "$@" ;;
        add|new)    skills_add "$@" ;;
        edit)       skills_edit "$@" ;;
        show|view)  skills_show "$@" ;;
        remove|rm|delete) skills_remove "$@" ;;
        help|--help|-h)
            echo "Skills æŠ€èƒ½ç®¡ç†å‘½ä»¤ï¼ˆä¸‰çº§æ¶æ„ï¼‰"
            echo ""
            echo "ç”¨æ³•: agentflow skills <å‘½ä»¤> [å‚æ•°]"
            echo ""
            echo "å‘½ä»¤:"
            echo "  list              åˆ—å‡ºæ‰€æœ‰ skillsï¼ˆé»˜è®¤ï¼‰"
            echo "  add <name>        æ·»åŠ é¡¹ç›®çº§ AgentFlow skill"
            echo "  add -g <name>     æ·»åŠ å…¨å±€ skillï¼ˆä¸ opencode å…±äº«ï¼‰"
            echo "  edit <name>       ç¼–è¾‘ skill"
            echo "  show <name>       æ˜¾ç¤º skill è¯¦æƒ…"
            echo "  remove <name>     åˆ é™¤ skill"
            echo ""
            echo "ä¸‰çº§è·¯å¾„:"
            echo "  å…¨å±€:     ~/.config/opencode/skills/<name>/SKILL.md"
            echo "            ä¸ opencode å…±äº«å…±ç”¨å…±ç»´æŠ¤"
            echo ""
            echo "  é¡¹ç›®çº§:   .github/skills/<name>/SKILL.md"
            echo "            AgentFlow ç‹¬æœ‰ï¼Œé€šè¿‡ CLI ç®¡ç†"
            echo ""
            echo "  VS Code:  .github/instructions/*.instructions.md"
            echo "            Copilot åŸç”Ÿæœºåˆ¶ï¼Œç›´æ¥ç¼–è¾‘æ–‡ä»¶"
            ;;
        *)
            # å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯å‘½ä»¤ï¼Œå¯èƒ½æ˜¯ skill åç§°ï¼ˆç”¨äºå¿«é€ŸæŸ¥çœ‹ï¼‰
            if validate_skill_name "$cmd" 2>/dev/null; then
                skills_show "$cmd" "$@"
            else
                echo "âŒ æœªçŸ¥ skills å‘½ä»¤: $cmd"
                echo "è¿è¡Œ 'agentflow skills help' æŸ¥çœ‹å¸®åŠ©"
                return 1
            fi
            ;;
    esac
}

# =============================================================================
# é¡¹ç›®åˆå§‹åŒ–
# =============================================================================

init_project() {
    local force=false
    local target="."
    
    # è§£æå‚æ•°
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --force|-f) force=true; shift ;;
            *) target="$1"; shift ;;
        esac
    done
    
    [[ ! -d "$target" ]] && mkdir -p "$target"
    target="$(cd "$target" && pwd)"
    echo "ğŸš€ åˆå§‹åŒ– AgentFlow åˆ°: $target"
    echo ""
    
    if [[ -d "$target/.github/agents" && "$force" != true ]]; then
        echo "âš ï¸  è­¦å‘Š: æ£€æµ‹åˆ°å·²æœ‰ AgentFlow é…ç½®"
        read -q "REPLY?æ˜¯å¦è¦†ç›–ç°æœ‰é…ç½®? (y/N) " || true
        echo
        [[ ! "$REPLY" =~ ^[Yy]$ ]] && echo "âŒ å·²å–æ¶ˆ" && return 1
    fi
    
    if [[ "$force" == true ]]; then
        echo "âš ï¸  å¼ºåˆ¶æ¨¡å¼ï¼šå°†è¦†ç›–æ‰€æœ‰ç°æœ‰é…ç½®"
        # å¤‡ä»½ project-memory.mdï¼ˆå³ä½¿å¼ºåˆ¶æ¨¡å¼ä¹Ÿä¿ç•™é¡¹ç›®è®°å¿†ï¼‰
        if [[ -f "$target/.github/project-memory.md" ]]; then
            local backup="$target/.github/project-memory.md.backup-$(date +%Y%m%d%H%M%S)"
            cp "$target/.github/project-memory.md" "$backup"
            echo "ğŸ“¦ å·²å¤‡ä»½ project-memory.md â†’ $(basename $backup)"
        fi
        # å¤‡ä»½ docs/ ç›®å½•
        if [[ -d "$target/.github/docs" ]]; then
            local docs_backup="$target/.github/docs-backup-$(date +%Y%m%d%H%M%S)"
            cp -r "$target/.github/docs" "$docs_backup"
            echo "ğŸ“¦ å·²å¤‡ä»½ docs/ â†’ $(basename $docs_backup)"
        fi
        # å¤‡ä»½ skills/ ç›®å½•
        if [[ -d "$target/.github/skills" ]]; then
            local skills_backup="$target/.github/skills-backup-$(date +%Y%m%d%H%M%S)"
            cp -r "$target/.github/skills" "$skills_backup"
            echo "ğŸ“¦ å·²å¤‡ä»½ skills/ â†’ $(basename $skills_backup)"
        fi
    fi
    
    echo "ğŸ“¦ å¤åˆ¶é…ç½®æ–‡ä»¶..."
    cp -r "$AGENTFLOW_HOME/template/.github" "$target/"
    cp -r "$AGENTFLOW_HOME/template/.vscode" "$target/" 2>/dev/null || true
    
    # å¤åˆ¶ç‰ˆæœ¬å·
    cp "$AGENTFLOW_HOME/VERSION" "$target/.github/VERSION" 2>/dev/null
    
    # åˆå§‹åŒ–æ–‡æ¡£ç›®å½•ç»“æ„
    init_docs_structure "$target"
    
    # åˆå§‹åŒ– Skills ç›®å½•ç»“æ„
    init_skills_structure "$target"
    
    echo ""
    echo "âœ… AgentFlow åˆå§‹åŒ–å®Œæˆ!"
    echo ""
    echo "ğŸ“ ä¸‹ä¸€æ­¥:"
    echo "  1. ç¼–è¾‘ .github/project-memory.md å¡«å†™é¡¹ç›®ä¿¡æ¯"
    echo "  2. ç”¨ VS Code æ‰“å¼€é¡¹ç›®: code $target"
    echo "  3. åœ¨ Copilot Chat ä¸­æµ‹è¯•: @plan ä½ å¥½"
    echo ""
    echo "ğŸ’¡ æç¤º: è¿è¡Œ 'agentflow validate' éªŒè¯é…ç½®å®Œæ•´æ€§"
}

init_docs_structure() {
    local target="$1"
    local docs_dir="$target/.github/docs"
    local version=$(cat "$AGENTFLOW_HOME/VERSION" 2>/dev/null || echo "1.0.0")
    local today=$(date +%Y-%m-%d)
    local now=$(date +"%Y-%m-%d %H:%M:%S")
    
    # åˆ›å»ºå­ç›®å½•
    mkdir -p "$docs_dir/plan" "$docs_dir/reports" "$docs_dir/references" "$docs_dir/archive"
    
    # åˆ›å»ºç›®å½• README.md å ä½æ–‡ä»¶
    [[ ! -f "$docs_dir/plan/README.md" ]] && cat > "$docs_dir/plan/README.md" << 'EOF'
# å¼€å‘è®¡åˆ’ç›®å½•

> å‘½åè§„èŒƒï¼š`YYYY-MM-DD-æè¿°.md`

å­˜æ”¾è¿›è¡Œä¸­çš„å¼€å‘è®¡åˆ’ã€‚å®Œæˆåç§»åŠ¨åˆ° `archive/` ç›®å½•ã€‚
EOF

    [[ ! -f "$docs_dir/reports/README.md" ]] && cat > "$docs_dir/reports/README.md" << 'EOF'
# å·¥ä½œæŠ¥å‘Šç›®å½•

> å‘½åè§„èŒƒï¼š`YYYY-MM-DD-ç±»å‹-æè¿°.md`
> ç±»å‹ï¼šbugfix / decision / analysis

å­˜æ”¾ Bug ä¿®å¤æŠ¥å‘Šã€æ¶æ„å†³ç­–æ–‡æ¡£ã€æŠ€æœ¯åˆ†æç­‰ã€‚
EOF

    [[ ! -f "$docs_dir/references/README.md" ]] && cat > "$docs_dir/references/README.md" << 'EOF'
# å‚è€ƒèµ„æ–™ç›®å½•

> å‘½åè§„èŒƒï¼š`æ¥æº-æ ‡é¢˜.md`

å­˜æ”¾å¤–éƒ¨æ–‡æ¡£ã€API æ‰‹å†Œã€æŠ€æœ¯æŒ‡å—ç­‰å‚è€ƒèµ„æ–™ã€‚
EOF

    [[ ! -f "$docs_dir/archive/README.md" ]] && cat > "$docs_dir/archive/README.md" << 'EOF'
# å†å²å½’æ¡£ç›®å½•

> å½’æ¡£è§„åˆ™ï¼š
> - å·²å®Œæˆè®¡åˆ’ï¼š`[å®Œæˆ]åŸæ–‡ä»¶å.md`
> - åºŸå¼ƒæ–¹æ¡ˆï¼š`[åºŸå¼ƒ]åŸæ–‡ä»¶å.md`
> - è¿‡æœŸæ–‡æ¡£ï¼š`[è¿‡æœŸ]åŸæ–‡ä»¶å.md`

å­˜æ”¾å·²å®Œæˆã€åºŸå¼ƒæˆ–è¿‡æœŸçš„å†å²æ–‡æ¡£ã€‚
EOF

    # åˆ›å»º manifest.json
    cat > "$docs_dir/manifest.json" << EOF
{
  "version": "$version",
  "lastUpdated": "$now",
  "documents": [
    {
      "path": "changelog/CHANGELOG.md",
      "status": "active",
      "created": "$today",
      "updated": "$today",
      "type": "changelog",
      "title": "å˜æ›´æ—¥å¿—",
      "changeType": "added"
    }
  ]
}
EOF
    
    # åˆ›å»º index.html é—¨æˆ·
    cat > "$docs_dir/index.html" << 'HTMLEOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentFlow æ–‡æ¡£é—¨æˆ·</title>
    <style>
        :root {
            --primary: #4F46E5;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg: #F9FAFB;
            --card: #FFFFFF;
            --text: #1F2937;
            --muted: #6B7280;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        header { text-align: center; margin-bottom: 2rem; }
        header h1 { font-size: 2rem; color: var(--primary); }
        header p { color: var(--muted); margin-top: 0.5rem; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat { background: var(--card); padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary); }
        .stat-label { color: var(--muted); font-size: 0.875rem; }
        .sections { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .section { background: var(--card); border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section h2 { font-size: 1.25rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .section-icon { font-size: 1.5rem; }
        .doc-list { list-style: none; }
        .doc-item { padding: 0.75rem 0; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center; }
        .doc-item:last-child { border-bottom: none; }
        .doc-link { color: var(--primary); text-decoration: none; }
        .doc-link:hover { text-decoration: underline; }
        .doc-date { color: var(--muted); font-size: 0.75rem; }
        .badge { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .badge-added { background: #D1FAE5; color: #065F46; }
        .badge-modified { background: #FEF3C7; color: #92400E; }
        .badge-archived { background: #E5E7EB; color: #374151; }
        .empty { color: var(--muted); font-style: italic; padding: 1rem 0; }
        footer { text-align: center; margin-top: 3rem; color: var(--muted); font-size: 0.875rem; }
        #lastUpdated { font-weight: 500; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“š AgentFlow æ–‡æ¡£é—¨æˆ·</h1>
            <p>AI è¾…åŠ©å¼€å‘å·¥ä½œæµç³»ç»Ÿ | æ–‡æ¡£ä¸­å¿ƒ</p>
        </header>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalDocs">-</div>
                <div class="stat-label">æ€»æ–‡æ¡£æ•°</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="activePlans">-</div>
                <div class="stat-label">è¿›è¡Œä¸­è®¡åˆ’</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalReports">-</div>
                <div class="stat-label">å·¥ä½œæŠ¥å‘Š</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="archivedDocs">-</div>
                <div class="stat-label">å·²å½’æ¡£</div>
            </div>
        </div>
        
        <div class="sections">
            <div class="section">
                <h2><span class="section-icon">ğŸ“</span> å¼€å‘è®¡åˆ’</h2>
                <ul class="doc-list" id="planList">
                    <li class="empty">æš‚æ— è¿›è¡Œä¸­çš„è®¡åˆ’</li>
                </ul>
            </div>
            
            <div class="section">
                <h2><span class="section-icon">ğŸ“Š</span> å·¥ä½œæŠ¥å‘Š</h2>
                <ul class="doc-list" id="reportList">
                    <li class="empty">æš‚æ— å·¥ä½œæŠ¥å‘Š</li>
                </ul>
            </div>
            
            <div class="section">
                <h2><span class="section-icon">ğŸ“‹</span> å˜æ›´æ—¥å¿—</h2>
                <ul class="doc-list" id="changelogList">
                    <li class="doc-item">
                        <a href="changelog/CHANGELOG.md" class="doc-link">CHANGELOG.md</a>
                        <span class="badge badge-added">æ´»è·ƒ</span>
                    </li>
                </ul>
            </div>
            
            <div class="section">
                <h2><span class="section-icon">ğŸ“–</span> å‚è€ƒèµ„æ–™</h2>
                <ul class="doc-list" id="referenceList">
                    <li class="empty">æš‚æ— å‚è€ƒèµ„æ–™</li>
                </ul>
            </div>
            
            <div class="section">
                <h2><span class="section-icon">ğŸ—„ï¸</span> æœ€è¿‘æ›´æ–°</h2>
                <ul class="doc-list" id="recentList">
                    <li class="empty">åŠ è½½ä¸­...</li>
                </ul>
            </div>
            
            <div class="section">
                <h2><span class="section-icon">ğŸ“¦</span> å†å²å½’æ¡£</h2>
                <ul class="doc-list" id="archiveList">
                    <li class="empty">æš‚æ— å½’æ¡£æ–‡æ¡£</li>
                </ul>
            </div>
        </div>
        
        <footer>
            <p>æœ€åæ›´æ–°: <span id="lastUpdated">-</span></p>
            <p>ç”± AgentFlow v1.0.0 è‡ªåŠ¨ç®¡ç†</p>
        </footer>
    </div>
    
    <script>
        // åŠ è½½ manifest.json æ›´æ–°é¡µé¢
        fetch('manifest.json')
            .then(r => r.json())
            .then(data => {
                document.getElementById('lastUpdated').textContent = data.lastUpdated;
                const docs = data.documents || [];
                
                // ç»Ÿè®¡
                document.getElementById('totalDocs').textContent = docs.length;
                document.getElementById('activePlans').textContent = docs.filter(d => d.type === 'plan' && d.status === 'active').length;
                document.getElementById('totalReports').textContent = docs.filter(d => d.type === 'report').length;
                document.getElementById('archivedDocs').textContent = docs.filter(d => d.status === 'archived').length;
                
                // å¡«å……åˆ—è¡¨
                const plans = docs.filter(d => d.type === 'plan' && d.status === 'active');
                const reports = docs.filter(d => d.type === 'report' && d.status !== 'archived');
                const refs = docs.filter(d => d.type === 'reference');
                const archived = docs.filter(d => d.status === 'archived');
                const recent = [...docs].sort((a, b) => b.updated.localeCompare(a.updated)).slice(0, 5);
                
                renderList('planList', plans);
                renderList('reportList', reports);
                renderList('referenceList', refs);
                renderList('archiveList', archived);
                renderList('recentList', recent);
            })
            .catch(() => {
                document.getElementById('lastUpdated').textContent = 'åŠ è½½å¤±è´¥';
            });
        
        function renderList(id, items) {
            const el = document.getElementById(id);
            if (items.length === 0) return;
            el.innerHTML = items.map(d => `
                <li class="doc-item">
                    <div>
                        <a href="${d.path}" class="doc-link">${d.title || d.path}</a>
                        <div class="doc-date">${d.updated}</div>
                    </div>
                    <span class="badge badge-${d.changeType}">${d.changeType === 'added' ? 'æ–°å¢' : d.changeType === 'modified' ? 'æ›´æ–°' : 'å½’æ¡£'}</span>
                </li>
            `).join('');
        }
    </script>
</body>
</html>
HTMLEOF
    
    echo "ğŸ“„ å·²åˆ›å»ºæ–‡æ¡£é—¨æˆ·: .github/docs/index.html"
    echo "ğŸ“‹ å·²åˆ›å»ºæ–‡æ¡£æ¸…å•: .github/docs/manifest.json"
}

# =============================================================================
# Skills ä¿¡æ¯æç¤º
# =============================================================================

init_skills_structure() {
    local target="$1"
    
    echo ""
    echo "ğŸ§  Skills æŠ€èƒ½ç³»ç»Ÿå·²å°±ç»ª"
    echo ""
    echo "   ä¸¤çº§æ¶æ„ï¼ˆå…±äº«å…±ç”¨å…±ç»´æŠ¤ï¼‰:"
    echo "   â”œâ”€â”€ å…¨å±€ Skills: ~/.config/opencode/skills/"
    echo "   â”‚   â””â”€â”€ ä¸ opencode å…±äº«ï¼Œä½¿ç”¨ 'agentflow skills add <name>' åˆ›å»º"
    echo "   â””â”€â”€ é¡¹ç›® Skills: .github/instructions/*.instructions.md"
    echo "       â””â”€â”€ VS Code/Copilot åŸç”Ÿæœºåˆ¶ï¼Œè‡ªåŠ¨åŠ è½½ï¼Œè‡ªåŠ¨è§¦å‘"
}

check_status() {
    echo "ğŸ” æ£€æŸ¥ AgentFlow å®‰è£…çŠ¶æ€..."
    echo ""
    
    local has_errors=0
    
    # æ£€æŸ¥å®‰è£…ç›®å½•
    if [[ -d "$AGENTFLOW_HOME" ]]; then
        echo "âœ… å®‰è£…ç›®å½•: $AGENTFLOW_HOME"
    else
        echo "âŒ å®‰è£…ç›®å½•ä¸å­˜åœ¨: $AGENTFLOW_HOME"
        has_errors=1
    fi
    
    # æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶
    if [[ -f "$AGENTFLOW_HOME/VERSION" ]]; then
        local version=$(cat "$AGENTFLOW_HOME/VERSION")
        echo "âœ… ç‰ˆæœ¬: v$version"
    else
        echo "âš ï¸  ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨"
    fi
    
    # æ£€æŸ¥æ¨¡æ¿ç›®å½•
    if [[ -d "$AGENTFLOW_HOME/template/.github" ]]; then
        echo "âœ… æ¨¡æ¿ç›®å½•: $AGENTFLOW_HOME/template"
    else
        echo "âŒ æ¨¡æ¿ç›®å½•ä¸å­˜åœ¨"
        has_errors=1
    fi
    
    # æ£€æŸ¥ Agents
    local agent_count=$(ls -1 "$AGENTFLOW_HOME/template/.github/agents" 2>/dev/null | wc -l | tr -d ' ')
    if [[ $agent_count -eq 5 ]]; then
        echo "âœ… Agents: $agent_count ä¸ª"
    else
        echo "âš ï¸  Agents: $agent_count ä¸ªï¼ˆé¢„æœŸ 5 ä¸ªï¼‰"
    fi
    
    # æ£€æŸ¥ Prompts
    local prompt_count=$(ls -1 "$AGENTFLOW_HOME/template/.github/prompts" 2>/dev/null | wc -l | tr -d ' ')
    if [[ $prompt_count -eq 7 ]]; then
        echo "âœ… Prompts: $prompt_count ä¸ª"
    else
        echo "âš ï¸  Prompts: $prompt_count ä¸ªï¼ˆé¢„æœŸ 7 ä¸ªï¼‰"
    fi
    
    # æ£€æŸ¥ç¯å¢ƒå˜é‡
    if [[ ":$PATH:" == *":$AGENTFLOW_HOME/bin:"* ]]; then
        echo "âœ… ç¯å¢ƒå˜é‡: å·²é…ç½®"
    else
        echo "âš ï¸  ç¯å¢ƒå˜é‡: æœªé…ç½®ï¼ˆéœ€è¦è¿è¡Œ source ~/.zshrcï¼‰"
    fi
    
    echo ""
    if [[ $has_errors -eq 0 ]]; then
        echo "âœ… AgentFlow å®‰è£…æ­£å¸¸"
        return 0
    else
        echo "âŒ AgentFlow å®‰è£…å­˜åœ¨é—®é¢˜"
        echo ""
        echo "ğŸ’¡ å°è¯•é‡æ–°å®‰è£…: cd ~/.agentflow/.. && ./install-global.sh"
        return 1
    fi
}

validate_project() {
    local target="${1:-.}"
    [[ ! -d "$target" ]] && echo "âŒ ç›®å½•ä¸å­˜åœ¨: $target" && return 1
    target="$(cd "$target" && pwd)"
    
    # æ£€æµ‹æ˜¯å¦æ˜¯ AgentFlow æºç ç›®å½•
    if [[ -d "$target/template/.github" && -f "$target/VERSION" && -d "$target/bin" ]]; then
        echo "ğŸ“¦ æ£€æµ‹åˆ° AgentFlow æºç ç›®å½•"
        echo "ğŸ” éªŒè¯ AgentFlow åŒ…å®Œæ•´æ€§: $target"
        echo ""
        validate_agentflow_package "$target"
        return $?
    fi
    
    echo "ğŸ” éªŒè¯ AgentFlow é…ç½®: $target"
    echo ""
    
    local has_errors=0
    local warnings=0
    
    # æ£€æŸ¥æ ¸å¿ƒç›®å½•
    if [[ -d "$target/.github" ]]; then
        echo "âœ… .github/ ç›®å½•å­˜åœ¨"
    else
        echo "âŒ .github/ ç›®å½•ä¸å­˜åœ¨"
        has_errors=1
    fi
    
    # æ£€æŸ¥ Agents
    if [[ -d "$target/.github/agents" ]]; then
        local agent_count=$(ls -1 "$target/.github/agents/"*.agent.md 2>/dev/null | wc -l | tr -d ' ')
        if [[ $agent_count -eq 5 ]]; then
            echo "âœ… Agents: $agent_count ä¸ª"
        else
            echo "âš ï¸  Agents: $agent_count ä¸ªï¼ˆé¢„æœŸ 5 ä¸ªï¼‰"
            warnings=$((warnings + 1))
        fi
    else
        echo "âŒ .github/agents/ ä¸å­˜åœ¨"
        has_errors=1
    fi
    
    # æ£€æŸ¥ Prompts
    if [[ -d "$target/.github/prompts" ]]; then
        local prompt_count=$(ls -1 "$target/.github/prompts/"*.prompt.md 2>/dev/null | wc -l | tr -d ' ')
        if [[ $prompt_count -eq 7 ]]; then
            echo "âœ… Prompts: $prompt_count ä¸ª"
        else
            echo "âš ï¸  Prompts: $prompt_count ä¸ªï¼ˆé¢„æœŸ 7 ä¸ªï¼‰"
            warnings=$((warnings + 1))
        fi
    else
        echo "âŒ .github/prompts/ ä¸å­˜åœ¨"
        has_errors=1
    fi
    
    # æ£€æŸ¥æ ¸å¿ƒé…ç½®æ–‡ä»¶
    local required_files=(
        ".github/copilot-instructions.md"
        ".github/project-memory.md"
        ".github/agentflow.yml"
    )
    
    for file in "${required_files[@]}"; do
        if [[ -f "$target/$file" ]]; then
            echo "âœ… $file"
        else
            echo "âŒ $file ä¸å­˜åœ¨"
            has_errors=1
        fi
    done
    
    # æ£€æŸ¥æ–‡æ¡£ç›®å½•
    if [[ -d "$target/.github/docs" ]]; then
        echo "âœ… .github/docs/ ç›®å½•å­˜åœ¨"
        if [[ ! -d "$target/.github/docs/changelog" ]]; then
            echo "âš ï¸  .github/docs/changelog/ ä¸å­˜åœ¨ï¼ˆå»ºè®®åˆ›å»ºï¼‰"
            warnings=$((warnings + 1))
        fi
    else
        echo "âš ï¸  .github/docs/ ç›®å½•ä¸å­˜åœ¨ï¼ˆå»ºè®®åˆ›å»ºï¼‰"
        warnings=$((warnings + 1))
    fi
    
    echo ""
    if [[ $has_errors -eq 0 ]]; then
        if [[ $warnings -eq 0 ]]; then
            echo "âœ… é…ç½®å®Œæ•´ï¼Œå¯ä»¥ä½¿ç”¨ï¼"
        else
            echo "âš ï¸  é…ç½®åŸºæœ¬å®Œæ•´ï¼Œæœ‰ $warnings ä¸ªè­¦å‘Š"
            echo "ğŸ’¡ è¿™äº›è­¦å‘Šä¸å½±å“åŸºæœ¬ä½¿ç”¨"
        fi
        return 0
    else
        echo "âŒ é…ç½®ä¸å®Œæ•´ï¼Œå‘ç° $has_errors ä¸ªé”™è¯¯"
        echo ""
        echo "ğŸ’¡ å°è¯•é‡æ–°åˆå§‹åŒ–: agentflow init $target"
        return 1
    fi
}

validate_agentflow_package() {
    local package_root="$1"
    local has_errors=0
    local warnings=0
    
    # æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶
    if [[ -f "$package_root/VERSION" ]]; then
        local version=$(cat "$package_root/VERSION")
        echo "âœ… VERSION: v$version"
    else
        echo "âŒ VERSION æ–‡ä»¶ä¸å­˜åœ¨"
        has_errors=1
    fi
    
    # æ£€æŸ¥ CLI å·¥å…·
    if [[ -f "$package_root/bin/agentflow" && -x "$package_root/bin/agentflow" ]]; then
        echo "âœ… CLI å·¥å…·: bin/agentflowï¼ˆå¯æ‰§è¡Œï¼‰"
    elif [[ -f "$package_root/bin/agentflow" ]]; then
        echo "âš ï¸  CLI å·¥å…·: bin/agentflowï¼ˆæ— æ‰§è¡Œæƒé™ï¼‰"
        warnings=$((warnings + 1))
    else
        echo "âŒ CLI å·¥å…·ä¸å­˜åœ¨"
        has_errors=1
    fi
    
    # æ£€æŸ¥å®‰è£…è„šæœ¬
    local scripts_count=0
    [[ -f "$package_root/scripts/install-global.sh" ]] && scripts_count=$((scripts_count + 1))
    [[ -f "$package_root/scripts/install-project.sh" ]] && scripts_count=$((scripts_count + 1))
    [[ -f "$package_root/scripts/uninstall.sh" ]] && scripts_count=$((scripts_count + 1))
    
    if [[ $scripts_count -eq 3 ]]; then
        echo "âœ… å®‰è£…è„šæœ¬: $scripts_count ä¸ª"
    else
        echo "âš ï¸  å®‰è£…è„šæœ¬: $scripts_count ä¸ªï¼ˆé¢„æœŸ 3 ä¸ªï¼‰"
        warnings=$((warnings + 1))
    fi
    
    # æ£€æŸ¥æ¨¡æ¿ç›®å½•
    if [[ -d "$package_root/template/.github" ]]; then
        echo "âœ… æ¨¡æ¿ç›®å½•: template/.github/"
    else
        echo "âŒ æ¨¡æ¿ç›®å½•ä¸å­˜åœ¨"
        has_errors=1
    fi
    
    # æ£€æŸ¥æ¨¡æ¿ä¸­çš„ Agents
    if [[ -d "$package_root/template/.github/agents" ]]; then
        local agent_count=$(ls -1 "$package_root/template/.github/agents/"*.agent.md 2>/dev/null | wc -l | tr -d ' ')
        if [[ $agent_count -eq 5 ]]; then
            echo "âœ… Agents: $agent_count ä¸ª"
        else
            echo "âš ï¸  Agents: $agent_count ä¸ªï¼ˆé¢„æœŸ 5 ä¸ªï¼‰"
            warnings=$((warnings + 1))
        fi
    else
        echo "âŒ template/.github/agents/ ä¸å­˜åœ¨"
        has_errors=1
    fi
    
    # æ£€æŸ¥æ¨¡æ¿ä¸­çš„ Prompts
    if [[ -d "$package_root/template/.github/prompts" ]]; then
        local prompt_count=$(ls -1 "$package_root/template/.github/prompts/"*.prompt.md 2>/dev/null | wc -l | tr -d ' ')
        if [[ $prompt_count -eq 7 ]]; then
            echo "âœ… Prompts: $prompt_count ä¸ª"
        else
            echo "âš ï¸  Prompts: $prompt_count ä¸ªï¼ˆé¢„æœŸ 7 ä¸ªï¼‰"
            warnings=$((warnings + 1))
        fi
    else
        echo "âŒ template/.github/prompts/ ä¸å­˜åœ¨"
        has_errors=1
    fi
    
    # æ£€æŸ¥æ ¸å¿ƒæ–‡æ¡£
    local doc_count=0
    [[ -f "$package_root/docs/INTEGRATION_GUIDE.md" ]] && doc_count=$((doc_count + 1))
    [[ -f "$package_root/docs/USER_MANUAL.md" ]] && doc_count=$((doc_count + 1))
    [[ -f "$package_root/docs/COMPARISON.md" ]] && doc_count=$((doc_count + 1))
    [[ -f "$package_root/docs/VERSION_HISTORY.md" ]] && doc_count=$((doc_count + 1))
    [[ -f "$package_root/docs/ROADMAP.md" ]] && doc_count=$((doc_count + 1))
    
    if [[ $doc_count -eq 5 ]]; then
        echo "âœ… æ ¸å¿ƒæ–‡æ¡£: $doc_count ä¸ª"
    else
        echo "âš ï¸  æ ¸å¿ƒæ–‡æ¡£: $doc_count ä¸ªï¼ˆé¢„æœŸ 5 ä¸ªï¼‰"
        warnings=$((warnings + 1))
    fi
    
    # æ£€æŸ¥ README å’Œ CHANGELOG
    [[ -f "$package_root/README.md" ]] && echo "âœ… README.md" || { echo "âŒ README.md ä¸å­˜åœ¨"; has_errors=1; }
    [[ -f "$package_root/CHANGELOG.md" ]] && echo "âœ… CHANGELOG.md" || { echo "âš ï¸  CHANGELOG.md ä¸å­˜åœ¨"; warnings=$((warnings + 1)); }
    
    echo ""
    if [[ $has_errors -eq 0 ]]; then
        if [[ $warnings -eq 0 ]]; then
            echo "âœ… AgentFlow åŒ…å®Œæ•´ï¼Œå¯ä»¥å‘å¸ƒï¼"
            echo ""
            echo "ğŸ“¦ ä¸‹ä¸€æ­¥:"
            echo "  1. æ‰§è¡Œå…¨å±€å®‰è£…: ./scripts/install-global.sh"
            echo "  2. æˆ–æ‰“åŒ…å‘å¸ƒ: tar -czf AgentFlow-v\$(cat VERSION).tar.gz ."
        else
            echo "âš ï¸  AgentFlow åŒ…åŸºæœ¬å®Œæ•´ï¼Œæœ‰ $warnings ä¸ªè­¦å‘Š"
            echo "ğŸ’¡ è¿™äº›è­¦å‘Šä¸å½±å“åŸºæœ¬åŠŸèƒ½"
        fi
        return 0
    else
        echo "âŒ AgentFlow åŒ…ä¸å®Œæ•´ï¼Œå‘ç° $has_errors ä¸ªé”™è¯¯"
        echo ""
        echo "ğŸ’¡ è¯·æ£€æŸ¥ç¼ºå¤±çš„æ–‡ä»¶æˆ–ç›®å½•"
        return 1
    fi
}

update_agentflow() {
    local target="${1:-.}"
    local current_version local_version remote_version
    local agentflow_repo="https://github.com/kdanmobile/AgentFlow"
    
    echo "ğŸ”„ AgentFlow æ›´æ–°æ£€æŸ¥"
    echo "========================"
    echo ""
    
    # è·å–å…¨å±€å®‰è£…ç‰ˆæœ¬
    if [[ -f "$AGENTFLOW_HOME/VERSION" ]]; then
        current_version=$(cat "$AGENTFLOW_HOME/VERSION")
        echo "ğŸ“¦ å…¨å±€ç‰ˆæœ¬: v$current_version"
    else
        current_version="æœªå®‰è£…"
        echo "âš ï¸  å…¨å±€ç‰ˆæœ¬: æœªå®‰è£…"
    fi
    
    # è·å–é¡¹ç›®æœ¬åœ°ç‰ˆæœ¬ï¼ˆå¦‚æœå·²åˆå§‹åŒ–ï¼‰
    if [[ -f "$target/.github/agentflow.yml" ]]; then
        if [[ -f "$target/.github/VERSION" ]]; then
            local_version=$(cat "$target/.github/VERSION")
            echo "ğŸ“ é¡¹ç›®ç‰ˆæœ¬: v$local_version"
        else
            local_version="æœªçŸ¥"
            echo "ğŸ“ é¡¹ç›®ç‰ˆæœ¬: å·²é…ç½®ï¼Œç‰ˆæœ¬æœªçŸ¥"
        fi
    else
        local_version="æœªåˆå§‹åŒ–"
        echo "ğŸ“ é¡¹ç›®çŠ¶æ€: æœªåˆå§‹åŒ– AgentFlow"
    fi
    
    echo ""
    
    # æ›´æ–°æ¨¡å¼é€‰æ‹©
    echo "ğŸ“‹ æ›´æ–°é€‰é¡¹:"
    echo "  1. æ›´æ–°å…¨å±€å®‰è£… (å½±å“æ‰€æœ‰æ–°é¡¹ç›®)"
    echo "  2. æ›´æ–°å½“å‰é¡¹ç›® (ä¿ç•™è‡ªå®šä¹‰é…ç½®)"
    echo "  3. å…¨éƒ¨æ›´æ–° (å…¨å±€ + å½“å‰é¡¹ç›®)"
    echo ""
    echo "ğŸ”§ æ›´æ–°å‘½ä»¤:"
    echo ""
    echo "  # æ–¹å¼ä¸€ï¼šä» GitHub æ‹‰å–æœ€æ–°ç‰ˆæœ¬æ›´æ–°å…¨å±€"
    echo "  cd ~/.agentflow && git pull origin main && ./scripts/install-global.sh"
    echo ""
    echo "  # æ–¹å¼äºŒï¼šæ›´æ–°å½“å‰é¡¹ç›®ï¼ˆä¿ç•™è‡ªå®šä¹‰ï¼‰"
    echo "  agentflow sync ."
    echo ""
    echo "  # æ–¹å¼ä¸‰ï¼šå¼ºåˆ¶é‡ç½®é¡¹ç›®é…ç½®ï¼ˆè¦†ç›–è‡ªå®šä¹‰ï¼‰"
    echo "  agentflow init --force ."
    echo ""
    
    # æä¾›åŒæ­¥åŠŸèƒ½
    if [[ "$2" == "--sync" || "$2" == "-s" ]]; then
        sync_project "$target"
    fi
}

sync_project() {
    local target="${1:-.}"
    local backup_dir="$target/.github/.agentflow-backup-$(date +%Y%m%d%H%M%S)"
    
    echo "ğŸ”„ åŒæ­¥é¡¹ç›®é…ç½®..."
    echo ""
    
    # æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
    if [[ ! -f "$target/.github/agentflow.yml" ]]; then
        echo "âŒ é¡¹ç›®æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆè¿è¡Œ: agentflow init $target"
        return 1
    fi
    
    # æ£€æŸ¥å…¨å±€å®‰è£…
    if [[ ! -d "$AGENTFLOW_HOME/template/.github" ]]; then
        echo "âŒ å…¨å±€å®‰è£…ä¸å®Œæ•´ï¼Œè¯·å…ˆé‡æ–°å®‰è£… AgentFlow"
        return 1
    fi
    
    echo "ğŸ“‹ åŒæ­¥ç­–ç•¥ï¼ˆä¿ç•™è‡ªå®šä¹‰ï¼‰:"
    echo "  âœ… æ›´æ–°: agents/*.agent.mdï¼ˆåˆå¹¶æ–°åŠŸèƒ½ï¼‰"
    echo "  âœ… æ›´æ–°: prompts/*.prompt.mdï¼ˆåˆå¹¶æ–°åŠŸèƒ½ï¼‰"
    echo "  â­ï¸  è·³è¿‡: project-memory.mdï¼ˆä¿ç•™é¡¹ç›®è®°å¿†ï¼‰"
    echo "  â­ï¸  è·³è¿‡: instructions/ï¼ˆä¿ç•™é¡¹ç›®æŒ‡ä»¤ï¼‰"
    echo "  â­ï¸  è·³è¿‡: copilot-instructions.mdï¼ˆä¿ç•™è‡ªå®šä¹‰ï¼‰"
    echo "  â­ï¸  è·³è¿‡: agentflow.ymlï¼ˆä¿ç•™é…ç½®ï¼‰"
    echo "  â­ï¸  è·³è¿‡: docs/ï¼ˆä¿ç•™æ‰€æœ‰æ–‡æ¡£ï¼‰"
    echo ""
    
    # åˆ›å»ºå¤‡ä»½
    echo "ğŸ“¦ åˆ›å»ºå¤‡ä»½: $backup_dir"
    mkdir -p "$backup_dir"
    cp -r "$target/.github/agents" "$backup_dir/" 2>/dev/null
    cp -r "$target/.github/prompts" "$backup_dir/" 2>/dev/null
    
    # åŒæ­¥ Agentsï¼ˆä¿ç•™è‡ªå®šä¹‰ï¼Œæ·»åŠ æ–°æ–‡ä»¶ï¼‰
    echo ""
    echo "ğŸ¤– åŒæ­¥ Agents..."
    for agent in "$AGENTFLOW_HOME/template/.github/agents/"*.agent.md; do
        local agent_name=$(basename "$agent")
        local target_agent="$target/.github/agents/$agent_name"
        if [[ ! -f "$target_agent" ]]; then
            cp "$agent" "$target_agent"
            echo "  âœ… æ–°å¢: $agent_name"
        else
            echo "  â­ï¸  ä¿ç•™: $agent_nameï¼ˆå·²å­˜åœ¨ï¼‰"
        fi
    done
    
    # åŒæ­¥ Promptsï¼ˆä¿ç•™è‡ªå®šä¹‰ï¼Œæ·»åŠ æ–°æ–‡ä»¶ï¼‰
    echo ""
    echo "ğŸ“ åŒæ­¥ Prompts..."
    for prompt in "$AGENTFLOW_HOME/template/.github/prompts/"*.prompt.md; do
        local prompt_name=$(basename "$prompt")
        local target_prompt="$target/.github/prompts/$prompt_name"
        if [[ ! -f "$target_prompt" ]]; then
            cp "$prompt" "$target_prompt"
            echo "  âœ… æ–°å¢: $prompt_name"
        else
            echo "  â­ï¸  ä¿ç•™: $prompt_nameï¼ˆå·²å­˜åœ¨ï¼‰"
        fi
    done
    
    # æ›´æ–°ç‰ˆæœ¬å·
    cp "$AGENTFLOW_HOME/VERSION" "$target/.github/VERSION" 2>/dev/null
    
    echo ""
    echo "âœ… åŒæ­¥å®Œæˆï¼"
    echo "ğŸ“¦ å¤‡ä»½ä½ç½®: $backup_dir"
    echo ""
    echo "ğŸ’¡ å¦‚éœ€å¼ºåˆ¶è¦†ç›–æ‰€æœ‰é…ç½®: agentflow init --force $target"
}

refresh_docs_portal() {
    local target="${1:-.}"
    local docs_dir="$target/.github/docs"
    local manifest="$docs_dir/manifest.json"
    local now=$(date +"%Y-%m-%d %H:%M:%S")
    local today=$(date +%Y-%m-%d)
    
    echo "ğŸ”„ åˆ·æ–°æ–‡æ¡£é—¨æˆ·ï¼ˆå¢é‡æ›´æ–°ï¼‰..."
    echo ""
    
    if [[ ! -d "$docs_dir" ]]; then
        echo "âŒ æ–‡æ¡£ç›®å½•ä¸å­˜åœ¨: $docs_dir"
        echo "ğŸ’¡ è¯·å…ˆè¿è¡Œ: agentflow init $target"
        return 1
    fi
    
    # è¯»å–ç°æœ‰ manifest ä»¥ä¿ç•™ created æ—¶é—´æˆ³
    declare -A existing_created
    declare -A existing_status
    if [[ -f "$manifest" ]]; then
        # ä½¿ç”¨ Python è§£æ JSONï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
        if command -v python3 &>/dev/null; then
            eval $(python3 << PYEOF
import json
try:
    with open('$manifest', 'r') as f:
        data = json.load(f)
    for doc in data.get('documents', []):
        path = doc.get('path', '')
        created = doc.get('created', '$today')
        status = doc.get('status', 'active')
        print(f"existing_created['{path}']='{created}'")
        print(f"existing_status['{path}']='{status}'")
except:
    pass
PYEOF
)
        fi
    fi
    
    # æ‰«ææ‰€æœ‰æ–‡æ¡£
    local docs_json="["
    local first=true
    local total=0 plans=0 reports=0 refs=0 archived=0
    local added=0 modified=0
    
    # è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ æ–‡æ¡£è®°å½•
    add_doc() {
        local path="$1" type="$2" title="$3" status="${4:-active}"
        local created="${existing_created[$path]:-$today}"
        local change_type="added"
        
        # åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯æ›´æ–°
        if [[ -n "${existing_created[$path]}" ]]; then
            change_type="modified"
            ((modified++))
        else
            ((added++))
        fi
        
        [[ "$first" != true ]] && docs_json+=","
        docs_json+="{\"path\":\"$path\",\"status\":\"$status\",\"created\":\"$created\",\"updated\":\"$today\",\"type\":\"$type\",\"title\":\"$title\",\"changeType\":\"$change_type\"}"
        first=false
        ((total++))
    }
    
    # æ‰«æ changelog
    if [[ -f "$docs_dir/changelog/CHANGELOG.md" ]]; then
        add_doc "changelog/CHANGELOG.md" "changelog" "å˜æ›´æ—¥å¿—"
    fi
    
    # æ‰«æ plan/
    for f in "$docs_dir/plan/"*.md; do
        [[ ! -f "$f" ]] && continue
        [[ "$(basename "$f")" == "README.md" ]] && continue
        local fname=$(basename "$f")
        local title="${fname%.md}"
        add_doc "plan/$fname" "plan" "$title"
        ((plans++))
    done
    
    # æ‰«æ reports/
    for f in "$docs_dir/reports/"*.md; do
        [[ ! -f "$f" ]] && continue
        [[ "$(basename "$f")" == "README.md" ]] && continue
        local fname=$(basename "$f")
        local title="${fname%.md}"
        add_doc "reports/$fname" "report" "$title"
        ((reports++))
    done
    
    # æ‰«æ references/
    for f in "$docs_dir/references/"*.md; do
        [[ ! -f "$f" ]] && continue
        [[ "$(basename "$f")" == "README.md" ]] && continue
        local fname=$(basename "$f")
        local title="${fname%.md}"
        add_doc "references/$fname" "reference" "$title"
        ((refs++))
    done
    
    # æ‰«æ archive/
    for f in "$docs_dir/archive/"*.md; do
        [[ ! -f "$f" ]] && continue
        [[ "$(basename "$f")" == "README.md" ]] && continue
        local fname=$(basename "$f")
        local title="${fname%.md}"
        add_doc "archive/$fname" "archive" "$title" "archived"
        ((archived++))
    done
    
    docs_json+="]"
    
    # å†™å…¥ manifest.json
    local version=$(cat "$AGENTFLOW_HOME/VERSION" 2>/dev/null || echo "1.0.0")
    cat > "$manifest" << EOF
{
  "version": "$version",
  "lastUpdated": "$now",
  "documents": $docs_json
}
EOF
    
    echo "ğŸ“Š æ‰«æç»“æœ:"
    echo "   æ€»æ–‡æ¡£: $totalï¼ˆæ–°å¢: $added | æ›´æ–°: $modifiedï¼‰"
    echo "   è®¡åˆ’: $plans | æŠ¥å‘Š: $reports | å‚è€ƒ: $refs | å½’æ¡£: $archived"
    echo ""
    echo "âœ… manifest.json å·²æ›´æ–°ï¼ˆå¢é‡æ¨¡å¼ï¼‰"
    echo "ğŸ“„ é—¨æˆ·åœ°å€: $docs_dir/index.html"
}

configure_vscode_trust() {
    echo "ğŸ”§ é…ç½® VS Code ä¿¡ä»»è®¾ç½®ï¼ˆæ¶ˆé™¤ Allow å¼¹çª—ï¼‰"
    echo "================================================"
    echo ""
    
    # æ£€æµ‹ VS Code è®¾ç½®æ–‡ä»¶è·¯å¾„
    local VSCODE_SETTINGS
    if [[ -f "$HOME/Library/Application Support/Code/User/settings.json" ]]; then
        VSCODE_SETTINGS="$HOME/Library/Application Support/Code/User/settings.json"
    elif [[ -f "$HOME/.config/Code/User/settings.json" ]]; then
        VSCODE_SETTINGS="$HOME/.config/Code/User/settings.json"
    else
        VSCODE_SETTINGS=""
    fi
    
    echo "éœ€è¦æ·»åŠ çš„è®¾ç½®é¡¹ï¼š"
    echo ""
    echo '  "github.copilot.chat.runCommand.enabled": true,'
    echo '  "github.copilot.chat.allowFileOperations": true,'
    echo '  "terminal.integrated.allowWorkspaceConfiguration": true,'
    echo '  "security.workspace.trust.enabled": true,'
    echo '  "github.copilot.chat.agent.enabled": true,'
    echo '  "chat.agent.enabled": true'
    echo ""
    
    if [[ -z "$VSCODE_SETTINGS" ]]; then
        echo "âš ï¸  æœªæ£€æµ‹åˆ° VS Code è®¾ç½®æ–‡ä»¶"
        echo ""
        echo "è¯·æ‰‹åŠ¨é…ç½®ï¼š"
        echo "  1. æ‰“å¼€ VS Code"
        echo "  2. æŒ‰ Cmd+Shift+Pï¼ˆMacï¼‰æˆ– Ctrl+Shift+P"
        echo "  3. è¾“å…¥ 'Preferences: Open User Settings (JSON)'"
        echo "  4. æ·»åŠ ä¸Šè¿°é…ç½®é¡¹"
        return 1
    fi
    
    echo "æ£€æµ‹åˆ°è®¾ç½®æ–‡ä»¶: $VSCODE_SETTINGS"
    echo ""
    
    # æ£€æŸ¥æ˜¯å¦å·²é…ç½®
    if grep -q "github.copilot.chat.runCommand.enabled" "$VSCODE_SETTINGS" 2>/dev/null; then
        echo "âœ… å·²æ£€æµ‹åˆ° Copilot ç»ˆç«¯è®¾ç½®"
        echo ""
        echo "å½“å‰é…ç½®çŠ¶æ€ï¼š"
        grep -E "(runCommand|allowFileOperations|allowWorkspaceConfiguration|workspace.trust.enabled|agent.enabled)" "$VSCODE_SETTINGS" 2>/dev/null | head -10
        echo ""
        read -q "REPLY?æ˜¯å¦å¼ºåˆ¶é‡æ–°é…ç½®? (y/N) " || true
        echo ""
        [[ ! "$REPLY" =~ ^[Yy]$ ]] && echo "è·³è¿‡é…ç½®" && return 0
    fi
    
    # å¤‡ä»½
    local backup="$VSCODE_SETTINGS.agentflow-backup-$(date +%Y%m%d%H%M%S)"
    cp "$VSCODE_SETTINGS" "$backup"
    echo "ğŸ“¦ å·²å¤‡ä»½: $(basename $backup)"
    echo ""
    
    # ä½¿ç”¨ Python å®‰å…¨æ›´æ–° JSON
    python3 << PYEOF
import json
import sys

settings_file = "$VSCODE_SETTINGS"
try:
    with open(settings_file, 'r') as f:
        content = f.read()
        # å¤„ç†å¸¦æ³¨é‡Šçš„ JSONï¼ˆjsoncï¼‰
        import re
        content = re.sub(r'//.*$', '', content, flags=re.MULTILINE)
        content = re.sub(r'/\*.*?\*/', '', content, flags=re.DOTALL)
        settings = json.loads(content) if content.strip() else {}
except Exception as e:
    print(f"è¯»å–è®¾ç½®å¤±è´¥: {e}")
    settings = {}

# AgentFlow æ¨èè®¾ç½®
agentflow_settings = {
    "github.copilot.chat.runCommand.enabled": True,
    "github.copilot.chat.allowFileOperations": True,
    "github.copilot.chat.codeGeneration.useInstructionFiles": True,
    "terminal.integrated.allowWorkspaceConfiguration": True,
    "security.workspace.trust.enabled": True,
    "security.workspace.trust.startupPrompt": "never",
    "github.copilot.chat.agent.enabled": True,
    "chat.agent.enabled": True
}

# åˆå¹¶è®¾ç½®
updated = 0
for key, value in agentflow_settings.items():
    if key not in settings or settings[key] != value:
        settings[key] = value
        updated += 1

try:
    with open(settings_file, 'w') as f:
        json.dump(settings, f, indent=2)
    print(f"âœ… å·²æ›´æ–° {updated} é¡¹è®¾ç½®")
except Exception as e:
    print(f"âŒ å†™å…¥å¤±è´¥: {e}")
    sys.exit(1)
PYEOF
    
    echo ""
    echo "ğŸ‰ é…ç½®å®Œæˆï¼"
    echo ""
    echo "ä¸‹ä¸€æ­¥ï¼š"
    echo "  1. é‡å¯ VS Code"
    echo "  2. æ‰“å¼€é¡¹ç›®: code ."
    echo "  3. æµ‹è¯•: @plan æ‰§è¡Œä¸€ä¸ªä»»åŠ¡"
    echo ""
    echo "ğŸ’¡ æç¤ºï¼šé¦–æ¬¡æ‰§è¡Œä»å¯èƒ½éœ€è¦ç¡®è®¤ä¸€æ¬¡ï¼Œä¹‹åä¼šè‡ªåŠ¨è®°ä½é€‰æ‹©"
}

case "${1:-help}" in
    init)     shift; init_project "$@" ;;
    sync)     sync_project "${2:-.}" ;;
    version)  cat "$AGENTFLOW_HOME/VERSION" 2>/dev/null || echo "1.0.0" ;;
    status)   check_status ;;
    validate) validate_project "$2" ;;
    update)   update_agentflow "${2:-.}" ;;
    trust)    configure_vscode_trust ;;
    skills)   shift; handle_skills "$@" ;;
    docs)     
        if [[ -d "$AGENTFLOW_HOME/template/.github/docs/agentflow" ]]; then
            open "$AGENTFLOW_HOME/template/.github/docs/agentflow" 2>/dev/null || \
            echo "ğŸ“š æ–‡æ¡£ç›®å½•: $AGENTFLOW_HOME/template/.github/docs/agentflow"
        else
            echo "âŒ æ–‡æ¡£ç›®å½•ä¸å­˜åœ¨"
            exit 1
        fi
        ;;
    docs-refresh) refresh_docs_portal "${2:-.}" ;;
    portal)
        target="${2:-.}"
        if [[ -f "$target/.github/docs/index.html" ]]; then
            open "$target/.github/docs/index.html" 2>/dev/null || \
            echo "ğŸ“„ é—¨æˆ·åœ°å€: $target/.github/docs/index.html"
        else
            echo "âŒ é—¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ: agentflow init"
            exit 1
        fi
        ;;
    help|--help|-h) show_help ;;
    *)        echo "âŒ æœªçŸ¥å‘½ä»¤: $1"; echo ""; show_help; exit 1 ;;
esac
